apiVersion: v1
kind: ConfigMap
metadata:
  name: imagenamemutatingcontroller-configmap
  namespace: kube-system
data:
  default.conf: |-
    server {
            listen 443 ssl;

            server_name localhost;
            ssl_certificate /etc/nginx/ssl/tls.crt;
            ssl_certificate_key /etc/nginx/ssl/tls.key;

            location / {
                    proxy_pass http://127.0.0.1:3000;
            }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: imagenamemutatingcontroller
  namespace: kube-system
  labels:
    app: imagenamemutatingcontroller
    mutateimagename: never
spec:
  replicas: 1
  selector:
    matchLabels:
      app: imagenamemutatingcontroller
  template:
    metadata:
      labels:
        app: imagenamemutatingcontroller
    spec:
      initContainers:
        - name: certificate-init-container
          image: gcr.io/hightowerlabs/certificate-init-container:0.0.1
          imagePullPolicy: Always
          env:
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          args:
            - "-additional-dnsnames=imagenamemutatingcontroller-service.kube-system.svc"
            - "-cert-dir=/etc/tls"
            - "-namespace=$(NAMESPACE)"
            - "-pod-ip=$(POD_IP)"
            - "-pod-name=$(POD_NAME)"
            - "-service-names=imagenamemutatingcontroller-service"            
          volumeMounts:
            - name: tls
              mountPath: /etc/tls
      containers:
      - name: nginxhttps
        image: library/nginx:1.15
        ports:
        - containerPort: 443
          name: https
        volumeMounts:
        - mountPath: /etc/nginx/ssl
          name: tls
        - mountPath: /etc/nginx/conf.d
          name: configmap-volume
        livenessProbe:
          httpGet:
            path: /healthz
            port: https
            scheme: HTTPS
        readinessProbe:
          httpGet:
            path: /healthz
            port: https
            scheme: HTTPS
      - name: webhook
        image: lawrencegripper/imagenamemutatingcontroller:12
        env:
          - name: REWRITE_CONTAINER_REPOSITORY
            value: "gcr.co"            
      volumes:
      - name: tls
      - name: configmap-volume
        configMap:
          name: imagenamemutatingcontroller-configmap
---
apiVersion: v1
kind: Service
metadata:
  name: imagenamemutatingcontroller-service
  namespace: kube-system
spec:
  ports:
  - protocol: TCP
    port: 443
    targetPort: https
  selector:
    app: imagenamemutatingcontroller
  type: ClusterIP
---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: imagenamemutatingcontroller
webhooks:
- clientConfig:
    service:
      namespace: kube-system
      name: imagenamemutatingcontroller-service
    caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUV5RENDQXJDZ0F3SUJBZ0lSQUlnSG8zd3VpZXgvcVJ0K2pwTlBTOTB3RFFZSktvWklodmNOQVFFTEJRQXcKRFRFTE1Ba0dBMVVFQXhNQ1kyRXdIaGNOTVRnd09ESXdNRGd3TVRNd1doY05NakF3T0RFNU1EZ3dNVE13V2pBTgpNUXN3Q1FZRFZRUURFd0pqWVRDQ0FpSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnSVBBRENDQWdvQ2dnSUJBSmt6CkhlMWoyRHJzS09WSHdPaHI4MFRaRlZDU3owZXU3c3hMKzJNVlVwMTVJM0hHQUVkVUlyYzI5QnY0bHhqMWN6d1EKT25EVmxWSXBvWUhGdmJ4TUovWjEvZXRhTkFsSHdiV1V4YlYwaXd1N0dCcVpPT1FOYUpTc29Td2xVUEJYeXYvegpCUjFpRS9LbVRQYnhQa3ZqMUVMT0tmOGQwcFlqc2lNUGc4bXhKWVpVVjRxdldhSVdoSnowYUFBVzF3ODZJT3QxCnlmRVl4Qko0dVNTT0JnaDdBZ0gzRURibEVvWVF1RlN2bDVnd0xudHhoMTArS0pPWGo5NEZ6Ukl3VWVBYnUvS1oKMyttUzhPdDAwK09hSXRpSmR1cHpOSS9FNVByRjgrbDhaNTVwd0hRdDFQcEZGVFh4SEpJU0h3UVZpQjlHV3U5ZwpDdkxKdHU5RUV4Rzg3YnEvMkhCSHZlZFUrT1N6M1VNRXM5YlNVcFdiUFZkZkUyN2lkdkxNWTRSZGtQWEdOQ1kxCmRRQWFkRitVenEyVE9QWlU2cyswM3o2Q21NQUhMNFdQSHNzT2R1ZWVCSDA4Ukg2eDd0aldXOGNpYmpQRUJ5bW0Kckk4cWh6cTFVdnVYa21weUFhaE9RclIzb0ZmM2JOYVovb2MvQTI0cVNuWXVUbU1NSTk1WXlPT1I3dlltck5IZQp0b09ob2cyZ2RLL0ptQkFBbVZYTEdVQzBKYzJCWWdTRUdVcmRrUXp3SGYydVJYM280QTVyVUs1N092REo5azR6Ci8vK3pjUmRtQzlGMmdHVUE1SThNSVUyS3Rjb295MmVlMTkvZ3lscTBtOUFyaldRenpGUElHeU81SWM1UEZPcEcKV0FhaDk1a2V2Mjdhb0JJbSs3cXg5ckgrNnd3L1VzU1ByRjRrZHA0RkFnTUJBQUdqSXpBaE1BNEdBMVVkRHdFQgovd1FFQXdJQ3BEQVBCZ05WSFJNQkFmOEVCVEFEQVFIL01BMEdDU3FHU0liM0RRRUJDd1VBQTRJQ0FRQ1laL3k0CmlHd2lUUkpyeGxUY3VKQVByWjc0SllvVFgzeWlzUmRUcWlDQ0tEa0FaNU00WjlCbDZPU3Q1U0xzc1FkZUhMdXYKc1pCM2NWazdhajgzMzdnZjM3MTFuK3M2bXBaQnBneFJhSUcxWitoa3V0RDNSK1c2bEZ1MUo3U2pPMkZFYk4zSgoxeEdBZHNjRVhQWUYrZ0VYaSszZ3R4K2FvdjI0bnF0eURkT0dOWm42KzN3U3J0bzdJR0x0QUx6cUFwSWdkNko4CnVWeUtsOUo3eHZaMjVwUERFOUZqTzVBNFVGU1VTTmJyTmtmaERtQVhYN0RBTGprQ242VmwzYW5IbEFWQ0Q4Y1MKdGZSTlZwelJYR1hrM2QxV1lGRVAyeWJjb0dEN0xKMDQ0NnZrejU3UjhVUGFkclE4ZTMxaW1IMlVHYWF1UFN2VApLUXU0UjZSM3cyY2NmWFFzTDBWSXhCZGtPU1pCVUhhSzRmODRjbUFvY00vUGc1NFA5WkY0bkxFMmIrenBKMUNBCk5hMDAwb0xLNnplRWhMenQ0dVBQQ1MzYlB4QkNhaTVBTDZTVnRmdTEvOHFkVWx0dUtBQk51aFhockF3d1g2c3oKeFA2ZHhCTFVJRFRyNnNmbjdEUDNOT1NQUGdjdmZHM3pEZmluUlBseXRuUkNXTnFvY0xmYXhtKzJsVDlBclFJNQo2UUdKaytsOVVGSEVBb0tqK1Z1YUJ0T2xPeUd2S0ZKMWQ2SXlLQ2luQnFMZU1CbC9OK0M2VVRERTF4dGRYQlI0CkNnTFZPL3lIa2JoMXZCYWdzTGNRaUd3ZXRoZzRFY0tVbk14V1pVWndLVVhIZ3hicmZ4NVNsU0srd25wMjFnWCsKaEx3b1ZYOUVselNUNmlyUTZHUjNPd2Njc3N1eW1UN3RJY3YvWUE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  failurePolicy: Fail
  name: imagenamemutatingcontroller-service.kube-system.svc
  namespaceSelector:
    matchExpressions:
      - key: mutateimagename
        operator: NotIn
        values: [never]
  rules:
  - apiGroups:
    - apps
    - ""
    apiVersions:
    - v1
    operations:
    - CREATE
    - UPDATE
    resources:
    - deployments

